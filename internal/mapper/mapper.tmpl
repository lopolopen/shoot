{{- $s := firstLower .TypeName -}}
{{- $d := printf "%s_" (camelCase .DestTypeName) -}}
{{- $ToDest := printf "To%s" (pascalCase .DestPkgName) -}}
{{- $FromDest := printf "From%s" (pascalCase .DestPkgName) -}}
{{- if .DestPkgAlias -}}
{{- $ToDest = printf "To%s" (pascalCase .DestPkgAlias) -}}
{{- $FromDest = printf "From%s" (pascalCase .DestPkgAlias) -}}
{{- end -}}

// Code generated by "{{.CmdLine}}"; DO NOT EDIT. ({{.Version}})

package {{.PackageName}}

{{if .DestPkgAlias}}
import {{.DestPkgAlias}} "{{.DestPkgPath}}"
{{else}}
import "{{.DestPkgPath}}"
{{end}}

// {{$ToDest}} converts receiver to type {{.QualifiedDestTypeName}}
func ({{$s}} *{{.TypeName}}) {{$ToDest}}() *{{.QualifiedDestTypeName}} {
    if {{$s}} == nil {
        return nil
    }
    {{$d}} := new({{.QualifiedDestTypeName}}) {{"\n"}}
    {{- range $p := $.DestPtrPathList -}}
    if {{$d}}.{{$p}} == nil {
        {{$d}}.{{$p}} = new({{index $.DestPtrTypeMap $p}})
    } {{"\n"}}
    {{- end -}}

    {{- /* ----------------- */ -}}
    {{- range $sf := $.SrcFieldList -}}
    {{- $df := $sf.Target -}}
    {{- if $df -}}
    {{- $deref := cond $df.IsPtr "" "*" -}}
    {{- $star := cond $df.IsPtr "*" "" -}}
    {{- $evalue := evaluate $s $sf.Name $sf.IsGet -}}

    {{- $close := false -}}
    {{- if index $.SrcNeedReadCheckMap $sf.Name -}}
    if {{condofread $s $sf.Name true}} { {{"\n"}}
    {{- $close = true -}}
    {{- end -}}

    {{- if $df.IsSame -}}
    {{assign (dot $d $df.Name) $evalue $df.IsSet}} {{"\n"}} 
    {{- end -}}

    {{- if $df.IsConv -}}
    {{- $right := printf "%s(%s)" $df.Type $evalue -}}
    {{assign (dot $d $df.Name) $right $df.IsSet}} {{"\n"}} 
    {{- end -}}

    {{- if $df.Func -}}
    {{- $right := printf "%s.%s(%s)" $s $df.Func $evalue -}}
    {{assign (dot $d $df.Name) $right $df.IsSet}} {{"\n"}} 
    {{- end -}}

    {{- if $df.CanMap -}}
    {{- $right := "" -}}
    {{- if $sf.IsGet -}}
    {{print $s $sf.Name}} := {{$evalue}} {{"\n"}}
    {{- $right = printf "%s%s.%s()" $deref (print $s $sf.Name) $ToDest -}}
    {{- else -}}
    {{- $right = printf "%s%s.%s()" $deref $evalue $ToDest -}}
    {{- end -}}
    {{assign (dot $d $df.Name) $right $df.IsSet}} {{"\n"}}
    {{- end -}}

    {{- if $df.CanEachMap -}}
    {{- $xs := $evalue -}}
    {{- if $sf.IsGet -}}
    {{- $xs = print $s $sf.Name -}}
    {{$xs}} := {{$evalue}} {{"\n"}}
    {{- end -}}
    if {{$xs}} != nil {
        _ys := make([]{{$star}}{{$df.Type}}, len({{$xs}}))
        for _i, _x := range {{$xs}} { {{"\n"}}
            {{- if and $sf.IsPtr (not $df.IsPtr) -}}
            if _x == nil {
                continue
            } {{"\n"}}
            {{- end -}}
            _ys[_i] = {{$deref}}_x.{{$ToDest}}()
        }
        {{assign (dot $d $df.Name) "_ys" $df.IsSet}}
    } {{"\n"}}
    {{- end -}}

    {{- if $close -}}
    }  {{"\n"}}
    {{- end -}}

    {{- end -}} 
    {{- end -}}
    {{- /* ----------------- */ -}}

    {{- if $.WriteMethodName -}}
    {{$s}}.{{$.WriteMethodName}}({{$d}}) {{"\n"}}
    {{- end -}}
    return {{$d}}
}

// {{$FromDest}} reads from type {{.QualifiedDestTypeName}}, then writes back to receiver and returns it
func ({{$s}} *{{.TypeName}}) {{$FromDest}}({{$d}} *{{.QualifiedDestTypeName}}) *{{.TypeName}} {
    if {{$d}} == nil {
        return {{$s}}
    }
    if {{$s}} == nil {
        {{$s}} = new({{.TypeName}})
    } {{"\n"}}
    {{- range $p := $.SrcPtrPathList -}}
    if {{$s}}.{{$p}} == nil {
        {{$s}}.{{$p}} = new({{index $.SrcPtrTypeMap $p}})
    } {{"\n"}}
    {{- end -}}

    {{- /* ----------------- */ -}}
    {{- range $df := $.DestFieldList -}}
    {{- $sf := $df.Target -}}
    {{- if $sf -}}
    {{- $deref := cond $sf.IsPtr "" "*" -}}
    {{- $star := cond $sf.IsPtr "*" "" -}}
    {{- $evalue := evaluate $d $df.Name $df.IsGet -}}
    {{- $ref := cond $df.IsPtr "" "&" -}}

    {{- $close := false -}}
    {{- if index $.DestNeedReadCheckMap $sf.Name -}}
    if {{condofread $d $df.Name false}} { {{"\n"}}
    {{- $close = true -}}
    {{- end -}}

    {{- if $sf.IsSame -}} 
    {{assign (dot $s $sf.Name) $evalue $sf.IsSet}} {{"\n"}}
    {{- end -}}

    {{- if $sf.IsConv -}}
    {{- $right := printf "%s(%s)" $sf.Type (evaluate $d $df.Name  $df.IsGet) -}}
    {{assign (dot $s $sf.Name) $right $sf.IsSet}} {{"\n"}} 
    {{- end -}}

    {{- if $sf.Func -}}
    {{- $right := printf "%s.%s(%s)" $s $sf.Func $evalue -}}
    {{assign (dot $s $sf.Name) $right $sf.IsSet}} {{"\n"}} 
    {{- end -}}

    {{- if $sf.CanMap -}}
    {{- $right := "" -}}
    {{- if $df.IsGet -}}
    {{print $d $df.Name}} := {{$evalue}} {{"\n"}}
    {{- $right = printf "%snew(%s).%s(%s%s)" $deref $sf.Type $FromDest $ref (print $d $df.Name) -}}
    {{- else -}}
    {{- $right = printf "%snew(%s).%s(%s%s)" $deref $sf.Type $FromDest $ref $evalue -}}
    {{- end -}}
    {{assign (dot $s $sf.Name) $right $sf.IsSet}} {{"\n"}}
    {{- end -}}

    {{- if $sf.CanEachMap -}}
    {{- $xs := $evalue -}}
    {{- if $df.IsGet -}}
    {{- $xs = print $d $df.Name -}}
    {{$xs}} := {{$evalue}} {{"\n"}}
    {{- end -}}
    if {{$xs}} != nil {
        _ys := make([]{{$star}}{{$sf.Type}}, len({{$xs}}))
        for _i, _x := range {{$xs}} { {{"\n"}}
            {{- if and $df.IsPtr (not $sf.IsPtr) -}}
            if _x == nil {
                continue
            } {{"\n"}}
            {{- end -}}
            _ys[_i] = {{$deref}}new({{$sf.Type}}).{{$FromDest}}({{$ref}}_x)
        }
        {{assign (dot $s $sf.Name) "_ys" $sf.IsSet}}
    } {{"\n"}}
    {{- end -}}

    {{- if $close -}}
    }  {{"\n"}}
    {{- end -}}

    {{- end -}}
    {{- end -}}
    {{- /* ----------------- */ -}}

    {{- if $.ReadMethodName -}}
    {{$s}}.{{$.ReadMethodName}}({{$.ReadParamPrefix}}{{$d}}) {{"\n"}}
    {{- end -}}
    return {{$s}}
}

// ShootMap exists solely to fulfill the MapShooter interface contract
func ({{$s}} {{.TypeName}}) ShootMap() { /*noop*/ }
