// Code generated by "{{.Cmd}}"; DO NOT EDIT.

package {{.PackageName}}

import (
    "github.com/lopolopen/shoot"
)

type {{camelCase .TypeName}} struct{
    client *http.Client
	conf   *shoot.RestConf
}

{{range $item := .MethodList}}
func (c *{{camelCase $.TypeName}}) {{index $.SigMap .}} {
    {{- $retlist := index $.ReturnListMap . -}}
    {{- $errret := index $.ErrReturnMap . -}}
    {{- $rets := index $.ReturnsMap . -}}
    
    path_ := "{{index $.PathMap .}}"{{"\n"}}
    {{- $pms := index $.PathParamsMap . -}}
    {{- if $pms -}}
    {{- range $pms -}}
    {{- $key := . -}}
    {{- $alias := index (index $.AliasMap $item) . -}}
    {{- if $alias -}}{{- $key = $alias -}}{{- end -}}
    path_ = strings.Replace(path_, "{{printf "{%s}" $key}}", fmt.Sprintf("%v", {{.}}), 1){{"\n"}}
    {{- end}}
    {{end}}

    url_, err := url.JoinPath(c.conf.BaseURL(), path_)
    if err != nil {
        return {{$errret}}
    }
    {{$httpmethod := index $.HTTPMethodMap $item}}
    {{$body := "nil"}}
    {{if in $httpmethod $.BodyHTTPMethods}}
    {{$p := index $.BodyParamMap .}}
    bodyJson_, err := json.Marshal({{$p}})
    if err != nil {
        return {{$errret}}
    }
    {{$body = "bytes.NewReader(bodyJson_)"}}
    {{end}}

    {{if $.CtxParamMap}}
    req_, err := http.NewRequestWithContext({{index $.CtxParamMap .}}, "{{$httpmethod}}", url_, {{$body}})
    {{else}}
    req_, err := http.NewRequest("{{$httpmethod}}", url_, {{$body}})
    {{end -}}
    if err != nil {
        return {{$errret}}
    }{{- "\n" -}}

    {{- "\n" -}}
    {{- if not (in $httpmethod $.BodyHTTPMethods) -}}
    {{- $qs := index $.QueryParamsMap $item -}}
    {{- $qd := index $.QueryDictMap $item -}}
    {{- if or $qs $qd -}}
    query_ := req_.URL.Query(){{"\n"}}
    {{- end -}}
    {{- if $qs -}}
    {{- range $key := $qs -}}
    {{- $alias := index (index $.AliasMap $item) $key -}}
    {{- if not $alias}}{{$alias = $key}}{{end -}}
    query_.Set("{{$alias}}", fmt.Sprintf("%v", {{$key}})){{"\n"}}
    {{- end -}}
    {{- end -}}
    {{- if $qd -}}
    for k, v := range {{$qd}} {
        query_.Set(k, fmt.Sprintf("%v", v))
    }{{"\n"}}
    {{- end -}}
    {{- if or $qs $qd -}}
    req_.URL.RawQuery = query_.Encode(){{"\n"}}
    {{- end -}}
    {{- end -}}

    {{- "\n" -}}
    {{- range $key, $value := (index $.DefaultHeaders $httpmethod) -}}
    req_.Header.Add("{{$key}}", "{{$value}}"){{"\n"}}
    {{- end}}

    resp_, err := c.client.Do(req_)
    if err != nil {
        return {{$errret}}
    }
    defer resp_.Body.Close()

    body_, _ := io.ReadAll(resp_.Body)

    if resp_.StatusCode >= 500 {
        err = fmt.Errorf("server error %d: %s", resp_.StatusCode, string(body_))
        return {{$errret}}
    }

    {{- if eq (len $retlist) 0 -}}{{"\n"}}
    return nil
    {{- else if eq (len $retlist) 1 -}}{{"\n"}}
    var r_ {{index $retlist 0}}
    err = json.Unmarshal(body_, &r_)
    if err != nil {
		return {{$errret}}
	}
    return {{index $rets 0}}, nil
    {{else}}
    if resp_.StatusCode < 300 {
        var r_ {{index $retlist 0}}
        err = json.Unmarshal(body_, &r_)
        if err != nil {
            return {{$errret}}
        }
        return {{index $rets 0}}, nil, nil
    } else {
        var r_ {{index $retlist 1}}
        err = json.Unmarshal(body_, &r_)
        if err != nil {
            return {{$errret}}
        }
        return nil, {{index $rets 1}}, nil
    }
    {{- end -}}
}
{{end}}

// ConfigHTTPClient allows customization of the underlying http.Client.
func (c *{{camelCase .TypeName}}) ConfigHTTPClient(config func(*http.Client)) {{.TypeName}} {
	config(c.client)
    return c
}

// ShootRest exists solely to fulfill the RestShooter interface contract.
func (c *{{camelCase .TypeName}}) ShootRest() { /*noop*/ }

func init() {
	shoot.Register(func(conf shoot.RestConf) {{.TypeName}} {
		return &{{camelCase .TypeName}}{
			conf: &conf,
			client: &http.Client{
				Timeout: time.Duration(conf.Timeout()) * time.Second,
                Transport: conf.BuildMiddleware(),
			},
		}
	})
}
