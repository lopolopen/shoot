// Code generated by "{{.CmdLine}}"; DO NOT EDIT. ({{.Version}})

package {{.PackageName}}

import (
    "github.com/lopolopen/shoot"
)

type {{camelCase .TypeName}} struct{
    client *http.Client
	conf   *shoot.RestConf
}

{{range $item := .MethodList}}
func (c *{{camelCase $.TypeName}}) {{index $.SigMap .}} {
    {{- $errret := index $.ErrReturnMap . -}}
    {{- $result := index $.ReturnResultMap . -}}
    {{- $ptr := "" -}}
    {{- if $result.IsPtr -}}
    {{- $ptr = "&" -}}
    {{- end -}}
    
    path_ := "{{index $.PathMap .}}"{{"\n"}}
    {{- $pms := index $.PathParamsMap . -}}
    {{- if $pms -}}
    {{- range $pms -}}
    {{- $key := . -}}
    {{- $alias := index (index $.AliasMap $item) . -}}
    {{- if $alias -}}{{- $key = $alias -}}{{- end -}}
    path_ = strings.Replace(path_, "{{printf "{%s}" $key}}", fmt.Sprintf("%v", {{.}}), 1){{"\n"}}
    {{- end}}
    {{end}}

    url_, err := url.JoinPath(c.conf.BaseURL(), path_)
    if err != nil {
        return {{$errret}}
    }
    {{$httpmethod := index $.HTTPMethodMap $item}}
    {{$body := "nil"}}
    {{if in $httpmethod $.BodyHTTPMethods}}
    {{$p := index $.BodyParamMap .}}
    bodyJson_, err := json.Marshal({{$p}})
    if err != nil {
        return {{$errret}}
    }
    {{$body = "bytes.NewReader(bodyJson_)"}}
    {{end}}

    {{if $.CtxParamMap}}
    req_, err := http.NewRequestWithContext({{index $.CtxParamMap .}}, "{{$httpmethod}}", url_, {{$body}})
    {{else}}
    req_, err := http.NewRequest("{{$httpmethod}}", url_, {{$body}})
    {{end -}}
    if err != nil {
        return {{$errret}}
    }{{- "\n" -}}

    {{- "\n" -}}
    {{- if not (in $httpmethod $.BodyHTTPMethods) -}}
    {{- $qs := index $.QueryParamsMap $item -}}
    {{- $qd := index $.QueryDictMap $item -}}
    {{- $isPtrMap := index $.IsParamPtrMap $item -}}
    {{- if or $qs $qd -}}
    query_ := req_.URL.Query(){{"\n"}}
    {{- end -}}
    {{- if $qs -}}
    {{- range $key := $qs -}}
    {{- $alias := index (index $.AliasMap $item) $key -}}
    {{- if not $alias}}{{$alias = $key}}{{end -}}
    {{- if index $isPtrMap $key -}}
    if {{$key}} != nil {
        query_.Set("{{$alias}}", fmt.Sprintf("%v", *{{$key}}))
    }{{"\n"}}
    {{- else -}}
    query_.Set("{{$alias}}", fmt.Sprintf("%v",{{$key}})){{"\n"}}
    {{- end -}}
    {{- end -}}
    {{- end -}}
    {{- if $qd -}}
    for k, v := range {{$qd}} {
        query_.Set(k, fmt.Sprintf("%v", v))
    }{{"\n"}}
    {{- end -}}
    {{- if or $qs $qd -}}
    req_.URL.RawQuery = query_.Encode(){{"\n"}}
    {{- end -}}
    {{- end -}}

    {{- "\n" -}}
    {{- range $key, $value := (index $.DefaultHeaders $httpmethod) -}}
    req_.Header.Add("{{$key}}", "{{$value}}"){{"\n"}}
    {{- end}}

    resp_, err := c.client.Do(req_)
    if err != nil {
        return {{$errret}}
    }
    defer resp_.Body.Close()

    switch {
        case resp_.StatusCode >= 500:
            body_, _ := io.ReadAll(resp_.Body)
            err = fmt.Errorf("server error %d: %s", resp_.StatusCode, string(body_))
        case resp_.StatusCode >= 400:
            body_, _ := io.ReadAll(resp_.Body)
            err = fmt.Errorf("client error %d: %s", resp_.StatusCode, string(body_))
        case resp_.StatusCode >= 300 || resp_.StatusCode < 200:
            err = fmt.Errorf("not supported error %d",resp_.StatusCode)
    }{{- "\n" -}}

    {{- if not $result.Type -}}
    if err != nil {
        return resp_, err
    }
    return resp_, nil
    {{- else -}}
    if err != nil {
        return nil, resp_, err
    }

    var r_ {{$result.Type}}
    err = json.NewDecoder(resp_.Body).Decode(&r_)
    if err == io.EOF {
        err = nil //ignore EOF errors caused by empty response body
    }
    if err != nil {
        return nil, resp_, err
    }
    return {{$ptr}}r_, resp_, nil
    {{- end -}}
}
{{end}}

// ConfigHTTPClient allows customization of the underlying http.Client.
func (c *{{camelCase .TypeName}}) ConfigHTTPClient(config func(*http.Client)) {{.TypeName}} {
	config(c.client)
    return c
}

// ShootRest exists solely to fulfill the RestShooter interface contract.
func (c *{{camelCase .TypeName}}) ShootRest() { /*noop*/ }

func init() {
	shoot.Register(func(conf shoot.RestConf) {{.TypeName}} {
		return &{{camelCase .TypeName}}{
			conf: &conf,
			client: &http.Client{
				Timeout: time.Duration(conf.Timeout()) * time.Second,
                Transport: conf.BuildMiddleware(),
			},
		}
	})
}
